<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Baconz â€” Local AI Chat (Client-only)</title>
<style>
  :root{
    --accent:#1e88e5;
    --glass: rgba(255,255,255,0.55);
    --muted:#7b8794;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:linear-gradient(135deg,#e3f2fd,#f3e8ff); color:#12202b}
  .app{max-width:1100px;margin:24px auto;height:calc(100vh - 48px);display:flex;gap:18px}
  .panel{border-radius:14px;padding:16px;background:var(--glass);backdrop-filter:blur(8px);box-shadow:0 6px 30px rgba(16,24,40,0.08)}
  .sidebar{width:280px;display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;gap:8px;justify-content:space-between}
  h1{font-size:1.05rem;margin:0;color:var(--accent)}
  .chat-list{overflow:auto;display:flex;flex-direction:column;gap:10px;padding-top:8px;height:100%}
  .chat-item{padding:10px;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;color:#12202b;display:flex;justify-content:space-between;align-items:center}
  .chat-item.active{background:linear-gradient(90deg,var(--accent),#42a5f5);color:white;box-shadow:0 6px 18px rgba(30,136,229,0.14);}
  .small{font-size:0.85rem;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--accent);color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .main{flex:1;display:flex;flex-direction:column;height:100%}
  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:72%;padding:12px 14px;border-radius:14px;position:relative;line-height:1.35;white-space:pre-wrap}
  .msg.user{align-self:flex-end;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#1b1b1b}
  .msg.ai{align-self:flex-start;background:linear-gradient(135deg,#bbdefb,#64b5f6);color:white}
  .msg .meta{display:block;font-size:0.75rem;color:rgba(255,255,255,0.8);opacity:.9;margin-top:8px;text-align:right}
  .meta.dark{color:rgba(0,0,0,0.6)}
  .typing{font-style:italic;color:var(--muted);padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.6);width:max-content}
  .composer{display:flex;gap:10px;padding-top:10px}
  input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);outline:none;font-size:1rem}
  input[type="text"]:focus{box-shadow:0 4px 18px rgba(30,136,229,0.12);border-color:var(--accent)}
  .meta-row{display:flex;gap:8px;align-items:center}
  .footer-note{font-size:0.8rem;color:var(--muted);text-align:center;padding-top:8px}
  @media (max-width:860px){.app{flex-direction:column;height:auto}.sidebar{width:100%;flex-direction:row;overflow:auto}.main{height:600px}}
</style>
</head>
<body>
  <div class="app">
    <div class="panel sidebar">
      <div class="topbar">
        <h1>ðŸ’¬ Chats</h1>
        <div class="meta-row small">Local only</div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="newChatBtn" class="btn-primary">ï¼‹ New</button>
        <button id="renameBtn" class="btn-ghost">Rename</button>
        <button id="clearBtn" class="btn-ghost">Clear Chat</button>
      </div>

      <div class="chat-list panel" id="chatList" style="padding:12px"></div>
      <div class="small footer-note">Double-click a chat to rename. Chats are stored in your browser.</div>
    </div>

    <div class="panel main">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div>
          <div id="chatTitle" style="font-weight:700;font-size:1.05rem">Main Chat</div>
          <div id="chatSubtitle" class="small">No messages yet</div>
        </div>
        <div class="small">Timestamps: local</div>
      </div>

      <div class="messages" id="messages"></div>

      <div style="margin-top:8px" id="typingWrap"></div>

      <div class="composer">
        <input id="inputBox" type="text" placeholder="Say something to Baconz..." autocomplete="off" />
        <button id="sendBtn" class="btn-primary">Send</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   CONFIG: paste your key here
   ============================
   Replace the placeholder string below with your new key locally:
     const OPENAI_KEY = "PASTE_YOUR_OPENAI_KEY_HERE";
   Do NOT commit or share that file publicly.
*/
const OPENAI_KEY = "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";

/* ============================
   App state & storage helpers
   ============================ */
const STORAGE_KEY = "baconz_local_chats_v1";

let chats = [];           // array: { id, name, messages: [{type:'user'|'ai', text, t}] }
let activeChatId = null;

const el = {
  chatList: document.getElementById('chatList'),
  messages: document.getElementById('messages'),
  chatTitle: document.getElementById('chatTitle'),
  chatSubtitle: document.getElementById('chatSubtitle'),
  inputBox: document.getElementById('inputBox'),
  sendBtn: document.getElementById('sendBtn'),
  newChatBtn: document.getElementById('newChatBtn'),
  renameBtn: document.getElementById('renameBtn'),
  clearBtn: document.getElementById('clearBtn'),
  typingWrap: document.getElementById('typingWrap'),
};

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ chats, activeChatId }));
}
function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    chats = parsed.chats || [];
    activeChatId = parsed.activeChatId || (chats[0] && chats[0].id) || null;
    return true;
  } catch (e) {
    console.error("Load error", e);
    return false;
  }
}
function uid() { return Math.random().toString(36).slice(2,10); }

/* ================
   UI rendering
   ================ */
function renderChatList() {
  el.chatList.innerHTML = "";
  chats.forEach(c => {
    const d = document.createElement('div');
    d.className = 'chat-item' + (c.id === activeChatId ? ' active' : '');
    d.innerHTML = `<div style="flex:1">${escapeHtml(c.name)}</div><div class="small">${c.messages.length}</div>`;
    d.onclick = () => { setActiveChat(c.id); };
    d.ondblclick = () => { renameChat(c.id); };
    el.chatList.appendChild(d);
  });
}

function setActiveChat(id) {
  activeChatId = id;
  const c = chats.find(x => x.id === id);
  if (!c) return;
  el.chatTitle.textContent = c.name;
  el.chatSubtitle.textContent = c.messages.length ? `${c.messages.length} messages` : 'No messages yet';
  renderMessages();
  save();
  renderChatList();
}

function renderMessages() {
  el.messages.innerHTML = "";
  const c = chats.find(x => x.id === activeChatId);
  if (!c) return;
  c.messages.forEach(m => {
    appendMessageToDOM(m);
  });
  el.messages.scrollTop = el.messages.scrollHeight;
}

function appendMessageToDOM(msg) {
  const div = document.createElement('div');
  div.className = 'msg ' + (msg.type === 'user' ? 'user' : 'ai');
  const time = new Date(msg.t).toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'});
  // message text (escaped)
  div.innerHTML = `<div>${escapeHtml(msg.text)}</div><div class="${msg.type==='user'?'meta dark':'meta'}">${time}</div>`;
  el.messages.appendChild(div);
  el.messages.scrollTop = el.messages.scrollHeight;
}

/* ================
   Actions
   ================ */
function createNewChat(name = "New Chat") {
  const id = uid();
  const chat = { id, name, messages: [] };
  chats.unshift(chat);            // new chats at top
  setActiveChat(id);
  save();
}

function renameChat(id) {
  const chat = chats.find(c => c.id === id);
  if (!chat) return;
  const nv = prompt("Rename chat", chat.name);
  if (nv && nv.trim()) { chat.name = nv.trim(); save(); renderChatList(); setActiveChat(id); }
}

function clearActiveChat() {
  const chat = chats.find(c => c.id === activeChatId);
  if (!chat) return;
  if (!confirm("Clear all messages in this chat?")) return;
  chat.messages = [];
  save();
  renderMessages();
  el.chatSubtitle.textContent = 'No messages yet';
}

/* ================
   Helpers
   ================ */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

/* ================
   Typing indicator
   ================ */
let typingIndicatorEl = null;
function showTyping() {
  if (typingIndicatorEl) return;
  typingIndicatorEl = document.createElement('div');
  typingIndicatorEl.className = 'typing';
  typingIndicatorEl.textContent = 'Baconz is typing...';
  el.typingWrap.appendChild(typingIndicatorEl);
  el.typingWrap.scrollIntoView({behavior:'smooth'});
}
function hideTyping() {
  if (!typingIndicatorEl) return;
  typingIndicatorEl.remove();
  typingIndicatorEl = null;
}

/* ================
   OpenAI call (client-side)
   ================ */
async function callOpenAI(messagesForApi) {
  // Basic safety: make sure key placeholder isn't left
  if (!OPENAI_KEY || OPENAI_KEY.includes('PASTE_YOUR_OPENAI_KEY_HERE')) {
    console.warn('OpenAI key not set or placeholder found.');
    return "âš ï¸ OpenAI key missing. Replace the placeholder in the HTML with your key.";
  }
  const payload = {
    model: "gpt-3.5-turbo",
    messages: messagesForApi,
    temperature: 0.8,
    max_tokens: 800
  };
  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_KEY}`
    },
    body: JSON.stringify(payload)
  });
  if (!resp.ok) {
    const t = await resp.text();
    throw new Error(`OpenAI API error ${resp.status}: ${t}`);
  }
  const j = await resp.json();
  return j.choices[0].message.content.trim();
}

/* ================
   Send flow
   ================ */
async function sendCurrentMessage() {
  const text = el.inputBox.value.trim();
  if (!text) return;
  const chat = chats.find(c => c.id === activeChatId);
  if (!chat) return;

  // push user message (with timestamp)
  const userMsg = { type: 'user', text, t: Date.now() };
  chat.messages.push(userMsg);
  appendMessageToDOM(userMsg);
  el.inputBox.value = '';
  el.chatSubtitle.textContent = `${chat.messages.length} messages`;
  save();

  // prepare API messages: system + all history mapped to roles + latest user
  const system = { role: "system", content: "You are Baconz, a friendly helpful assistant." };
  const history = chat.messages.map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.text }));
  const messagesForApi = [system, ...history];

  // typing indicator
  showTyping();

  try {
    // await network call
    const aiText = await callOpenAI(messagesForApi);
    const aiMsg = { type: 'ai', text: aiText, t: Date.now() };
    chat.messages.push(aiMsg);
    hideTyping();
    appendMessageToDOM(aiMsg);
    el.chatSubtitle.textContent = `${chat.messages.length} messages`;
    save();
  } catch (err) {
    hideTyping();
    const errMsg = { type: 'ai', text: "âš ï¸ Error contacting OpenAI: " + err.message, t: Date.now() };
    chat.messages.push(errMsg);
    appendMessageToDOM(errMsg);
    save();
    console.error(err);
  }
}

/* ================
   Init UI & events
   ================ */
el.sendBtn.addEventListener('click', sendCurrentMessage);
el.inputBox.addEventListener('keydown', e=>{ if(e.key==='Enter') sendCurrentMessage(); });
el.newChatBtn.addEventListener('click', ()=>{ const name = prompt('Chat name','New Chat'); createNewChat(name||'New Chat'); });
el.renameBtn.addEventListener('click', ()=>{ if (!activeChatId) return; renameChat(activeChatId); });
el.clearBtn.addEventListener('click', clearActiveChat);

function bootstrap() {
  const ok = load();
  if (!ok || chats.length===0) {
    // create default chat
    chats = [{ id: uid(), name: 'Main Chat', messages: [] }];
    activeChatId = chats[0].id;
    save();
  }
  renderChatList();
  setActiveChat(activeChatId || chats[0].id);
}
bootstrap();

/* -----------
   Extra: expose quick helper (optional)
   ----------- */
window.__baconz = {
  createNewChat,
  renameChat,
  saveAll: save,
  loadAll: load
};
</script>
</body>
</html>
